<!DOCTYPE HTML>
<html>
	<head>
		<title></title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="A platform to allow the youth of ireland to influence policy and get informed" />
		<meta name="keywords" content="key, ideas, decisions, politics, youth, ireland" />

		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<script src="https://cdn.firebase.com/js/client/2.0.2/firebase.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/js/bootstrap-dialog.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/typeahead.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/css/bootstrap-dialog.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/css/bootstrap-dialog.min.css"></script>
		<link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/social-button.css" />
		<link rel="stylesheet" href="https://rawgit.com/daneden/animate.css/master/animate.css" />
	</head>

	<style>
	.bootstrap-dialog.type-primary .modal-header{
	    background-color: #DC5843;
	}
	</style>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-70155327-1', 'auto');
	  ga('send', 'pageview');

	</script>
  <script>
    // populate body with water charges blurb
    var waterChargesInfo = 'https://glaring-torch-16.firebaseio.com/info/water_charges.json';

    $.ajax(
    {
      type: "GET",
      url: waterChargesInfo,
      data: "{}",
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function (data) {
        $("#body").html(data);
      }
    });

		displayPosts();

    //populate comments section
    function displayPosts(){
			var commentsUrl = 'https://glaring-torch-16.firebaseio.com/discussion_topics/water_charges/comments.json';

      var commentIndexMappings = [];
      $.ajax(
      {
        type: "GET",
        url: commentsUrl,
        data: "{}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
          var commentsArr = $.map(data, function(el, i)
          {
            commentIndexMappings.push(i);
            return el;
          })

          var html = '</br></br></br><div class = "container"><div class="row main-row">';

            for(var i=commentsArr.length-1; i>=0;i--){
              html += '<div id="'+commentIndexMappings[i]+'" class="form-group"><table style="width:100%"><tr><td style="text-align: left; width:20%";><img class="img-circle" width="50" height="50" src="' + commentsArr[i].profilePicUrl + '">';
              html += '<div>' + commentsArr[i].userName + '</td><td style="text-align: left;"><div class="titleBox"><label>';
              html += commentsArr[i].text;
              html += '</td><td style="text-align: right; width:20%";><button onclick="checkCanDeleteComment(\''+ commentIndexMappings[i] +'\', \''+ commentsArr[i].text +'\', \''+ commentsArr[i].userName.replace("'", "") +'\')" title="Delete Comment?" class="glyphicon glyphicon-remove"></button></label></div><div class="commentBox"><p class="taskDescription">';
              html += '</td></tr></div>';
              html += '</br>';

              html += '</div>';
              html += '<form class="form-inline" role="form">';
              html += '</div></br><hr>';
            }

          html+='</div></div>';
          $("#forumComments").html(html);
        },
        error: function (msg, url, line) {
          alert('error');
        }
      	});
			}

			// function used to delete a comment, should only be able to
			function checkCanDeleteComment(commentId, commentText, userName){
				console.log('commentId:',commentId);
				console.log('commentText:',commentText);
				console.log('commenter:',userName);

				var ref = new Firebase("https://glaring-torch-16.firebaseio.com");

				//check if user is signed in and authenticated before allowing them to post content
				var authToken = ref.getAuth();

				if(authToken == null){
          BootstrapDialog.show({
                  title: 'Please Login',
                  message: 'Login in using the buttons on the top-right',
									cssClass: 'dialog-stlye'
          });
        }
				else{
					BootstrapDialog.show({
									title: 'Delete comment',
									message: 'Are you sure you want to delete this comment?',
									buttons: [{
	                label: 'Cancel',
									cssClass: 'dialog-stlye',
	                action: function(dialog) {
	                    dialog.close();
	                }
	            }, {
	                label: 'Yes I\'m sure',
	                action: function(dialog) {
	                    deleteComment(userName, commentId);
											dialog.close();
	                }
	            }]
					});
				}
			}

			function deleteComment(userName, commentId){
				if(deleteComment){
					var ref = new Firebase("https://glaring-torch-16.firebaseio.com");

	        //check if user is signed in and authenticated before allowing them to post content
	        var authToken = ref.getAuth();
					var authProvider = authToken.provider;
          var displayName;

          if(authProvider == "google"){
              displayName = authToken.google.displayName;
          }
          else if(authProvider == "facebook"){
            displayName = authToken.facebook.displayName;
          }
          else if(authProvider == "twitter"){
            displayName = authToken.twitter.displayName;
          }

					if(userName != displayName.replace("'", "")){
						BootstrapDialog.show({
										title: 'Action not permitted!',
										message: 'You can only delete your own comments!',
										cssClass: 'dialog-stlye'
						});
					}
					else{
						console.log('deleting comment: ' + commentId + ' by user:' + userName);
						var url = 'https://glaring-torch-16.firebaseio.com/discussion_topics/water_charges/comments/' + commentId + '.json';

						$.ajax(
	          {
	            type: "DELETE",
	            url: url,
	            contentType: "application/json; charset=utf-8",
	            dataType: "json",
	            success: function (data) {
	              console.log('comment: ' + commentId + ' succes deleted');
								displayPosts();
	            },
	            error: function (msg, url, line) {
	              alert('error');
	            }
	          });

					}
				}
			}

      // setup post button to allow posting of comments
      function postComment(){
        var ref = new Firebase("https://glaring-torch-16.firebaseio.com");

        //check if user is signed in and authenticated before allowing them to post content
        var authToken = ref.getAuth();

        if(authToken == null){
          BootstrapDialog.show({
                  title: 'Please Login',
                  message: 'Login in using the buttons on the top-right',
									cssClass: 'dialog-stlye'
          });
        }
        else{
          //users to alreadt logged in
          var url = 'https://glaring-torch-16.firebaseio.com/discussion_topics/water_charges/comments.json';
          var commentText = $('#commentTxtBox').val();
          commentText = commentText.replace(/\n/g, "");

          //get the user credentials (profile pic, username) from the auth token
          var ref = new Firebase("https://glaring-torch-16.firebaseio.com");

          //check if user is signed in and authenticated before allowing them to post content
          var authToken = ref.getAuth();
          var authProvider = authToken.provider;

          var profileImageURL;
          var displayName;

          if(authProvider == "google"){
              displayName = authToken.google.displayName;
              profileImageURL = authToken.google.profileImageURL
          }
          else if(authProvider == "facebook"){
            displayName = authToken.facebook.displayName;
            profileImageURL = authToken.facebook.profileImageURL
          }
          else if(authProvider == "twitter"){
            displayName = authToken.twitter.displayName;
            profileImageURL = authToken.twitter.profileImageURL
          }

          $.ajax(
          {
            type: "POST",
            url: url,
            data: '{"text" : "' + commentText + '", "userName" : "' + displayName.replace("'", "") + '", "profilePicUrl" : "' + profileImageURL + '"}'	,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
              $("#commentTxtBox").val('');
              displayPosts();
            },
            error: function (msg, url, line) {
              alert('error');
            }
          });
        }
    }

    $(document).ready(function()
    {
          $.get('navbarTemplate.html', function(data) {
          $('#navBar').html(data);
      });
    });

  </script>

  <body>

  <div id="navBar"></div>
	<div class = "row main-row" id="body"></div>
  <div id="forumComments"></div>

<script src="js/login.js"></script>
<br><br><br><br><br>
</body>
</html>
